
function log(s) { console.log(s); }

const formToJSON = (elements) =>
      [].reduce.call(
	  elements,
	  (data, element) => {
	      data[element.name] = element.value;
	      return data;
	  },
	  {},
      );


$(function(){

    <% if ENV['BOX'] == 'true' %>
    var ws = new WebSocket('ws://<%= request.host %>:8080');
    <% else %>
    var ws = new WebSocket('wss://<%= request.host %>:8080');
    <% end %>

    $(document).on('click', '.ws', function(ev) {
	ev.preventDefault();
	var h = {
	    u: '<%= params[:u] %>',
	    dev: '<%= params[:dev] %>',
	    trigger: $(this).val(),
	    lights: { front: $('#light_f').prop('checked'), back: $('#light_b').prop('checked') },
	    direction: $('#direction').prop('checked')
	}
	ws.send(JSON.stringify(h));
    });
    
    
    ws.onmessage = function(evt) {
	j = JSON.parse(evt.data);
	log(j);
    };
    
    ws.onclose = function() {
	log('closed');
    };
    
    ws.onopen = function() {
	ws.send(JSON.stringify({ trigger: 'OK', u: '<%= params[:u] %>', dev: '<%= params[:dev] %>' }));
    };
    
    
});
